version: '3.8'

services:
  app:
    build: .
    container_name: gudang-sparepart-app
    working_dir: /var/www
    volumes: # For Deployment on My Zima OS Server
      - /DATA/AppData/gudang-sparepart:/var/www
      - /DATA/AppData/gudang-sparepart/storage/app:/var/www/storage/app
      - /DATA/AppData/gudang-sparepart/storage/logs:/var/www/storage/logs
      - /DATA/AppData/gudang-sparepart/vendor:/var/www/vendor
      - /DATA/AppData/gudang-sparepart/node_modules:/var/www/resources/js/node_modules
    ports:
      - '9090:9090' # PHP-FPM
      - '5173:5173' # Vite dev server (if needed)
    env_file:
      - .env
    depends_on:

    command: |
      sh -c "
        echo 'ğŸš€ Starting Gudang Sparepart...' &&
        if [ ! -f /var/www/.env ]; then
          echo 'âš™ï¸  .env not found, creating from .env.example...' &&
          cp /var/www/.env.example /var/www/.env &&
          php artisan key:generate --force &&
          echo 'âœ… APP_KEY generated!'
        fi &&
        php artisan config:cache &&
        php artisan route:cache &&
        php artisan view:cache &&
        php artisan storage:link &&
        php artisan migrate --force &&
        if [ ! -f /var/www/storage/.seeded ]; then
          echo 'ğŸŒ± Running seeder for the first time...' &&
          php artisan db:seed --force &&
          touch /var/www/storage/.seeded &&
          echo 'âœ… Seeding completed! Flag created.'
        else
          echo 'â­ï¸  Database already seeded, skipping seeder...'
        fi &&
        echo 'âœ… Application ready!' &&
        php-fpm
      "
